let isEnableExtension,crrId=0;const IDBG=0;function start(){loadHostRulesFromStorage(),chrome.contextMenus.create({title:"Block this element",id:"t-special-block-element",contexts:["page","selection","link","editable","image","video","audio"]},()=>{console.log(chrome.runtime.lastError)}),chrome.contextMenus.onClicked.addListener(onContextClick)}function stop(){removeAllRules(),chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["ruleset_1","ruleset_2","ruleset_3","ruleset_4"]}),chrome.contextMenus.remove("t-special-block-element",()=>{console.log(chrome.runtime.lastError)})}function setExtensionState(e){isEnableExtension=void 0==e||e,console.log(isEnableExtension),isEnableExtension?start():stop()}chrome.runtime.onMessage.addListener((e,t,o)=>{switch(console.log(e),e.name){case"disable-host-block":setExtensionState(!1);break;case"enable-host-block":chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["ruleset_1","ruleset_2","ruleset_3","ruleset_4"]}),setExtensionState(!0);break;case"update-user-host-block":isEnableExtension&&loadHostRulesFromStorage()}}),getFromChromeStorage("disableExtension").then(({disableExtension:e})=>{setExtensionState(!e)});const fetchTextFileByLine=e=>fetch(e).then(e=>e.text()).then(e=>e.split("\n"));function onContextClick(e,t){"t-special-block-element"==e.menuItemId&&chrome.tabs.sendMessage(t.id,{name:"start-block-by-menucontext"},{frameId:e.frameId})}function getFromChromeStorage(e){return new Promise((t,o)=>chrome.storage.sync.get(e,e=>chrome.runtime.lastError?o(chrome.runtime.lastError.message):t(e)))}const disableAllRules=()=>{if(crrId>0){let e=[];for(let t=1;t<=crrId;t++)e.push(t);chrome.declarativeNetRequest.updateDynamicRules({disableRulesetIds:e})}},removeAllRules=()=>{if(crrId>0){let e=[];for(let t=1;t<=crrId;t++)e.push(t);chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:e})}},setBlockHosts=e=>{removeAllRules();e.filter(e=>"#"!=e[0]).forEach((e,t)=>{crrId=t+1,e&&chrome.declarativeNetRequest.updateDynamicRules({addRules:[{id:crrId,priority:1,action:{type:"block"},condition:{urlFilter:e,resourceTypes:["main_frame","script","image","xmlhttprequest","sub_frame"]}}],removeRuleIds:[crrId]},()=>console.log(chrome.runtime.lastError))})};function handleBlockHostByTextInUrl(e){return fetchTextFileByLine(e).then(e=>{setBlockHosts(e)})}function getRulesRemove(e){let t;return(t="rulesRemoveElement"==e?getFromChromeStorage("rulesRemoveElement"):getFromChromeStorage("rulesRemoveSelector")).then(t=>t[e])}function loadHostRulesFromStorage(){getFromChromeStorage("hostRules").then(({hostRules:e})=>{e&&setBlockHosts(e)})}function saveToChromeStorage({key:e,value:t}){return new Promise((o,s)=>chrome.storage.sync.set({[e]:t},()=>chrome.runtime.lastError?s(chrome.runtime.lastError.message):o(()=>{console.log(`${e} saved`)})))}function initLocalData(){}function convertOldStoredRuleToNewRule(){["rulesRemoveSelector","rulesRemoveElement"].forEach(e=>{getRulesRemove(e).then(t=>{if(t){for(let o in t){let s=t[o].split(",");s.forEach((e,t)=>{let o=e.split("|");!(o.length<3)&&(s[t]=o[0]+"|"+o[4])}),t[o]=s.join(",")}saveToChromeStorage({key:e,value:t}).finally(()=>{})}})})}function convertOldata(){convertOldStoredRuleToNewRule()}chrome.runtime.onInstalled.addListener(function(e){"update"==e.reason&&convertOldata(),initLocalData()}),chrome.declarativeNetRequest.onRuleMatchedDebug.addListener(e=>console.log(e));