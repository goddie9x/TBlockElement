let isEnableExtension,crrId=0;const IDBG=!1;function removeAllRules(){if(crrId>0){let e=[];for(let t=1;t<=crrId;t++)e.push(t);chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:e})}}function fetchTextFileByLine(e){return fetch(e).then(e=>e.text()).then(e=>e.split("\n"))}function onContextClick(e,t){"t-special-block-element"==e.menuItemId&&chrome.tabs.sendMessage(t.id,{name:"start-block-by-menu-context"},{frameId:e.frameId})}function getFromChromeStorage(e){return new Promise((t,r)=>chrome.storage.sync.get(e,e=>chrome.runtime.lastError?r(chrome.runtime.lastError.message):t(e)))}function disableAllRules(){if(crrId>0){let e=[];for(let t=1;t<=crrId;t++)e.push(t);chrome.declarativeNetRequest.updateDynamicRules({disableRulesetIds:e})}}function setBlockHosts(e){removeAllRules();e.filter(e=>"#"!=e[0]).forEach((e,t)=>{crrId=t+1,e&&chrome.declarativeNetRequest.updateDynamicRules({addRules:[{id:crrId,priority:1,action:{type:"block"},condition:{urlFilter:e,resourceTypes:["main_frame","script","image","xmlhttprequest","sub_frame"]}}],removeRuleIds:[crrId]},()=>console.log(chrome.runtime.lastError))})}function handleBlockHostByTextInUrl(e){return fetchTextFileByLine(e).then(e=>{setBlockHosts(e)})}function getRulesRemove(e){let t;return(t="rulesRemoveElement"==e?getFromChromeStorage("rulesRemoveElement"):getFromChromeStorage("rulesRemoveSelector")).then(t=>t[e])}function loadHostRulesFromStorage(){getFromChromeStorage("hostRules").then(({hostRules:e})=>{e&&setBlockHosts(e)})}function saveToChromeStorage({key:e,value:t}){return new Promise((r,l)=>chrome.storage.sync.set({[e]:t},()=>chrome.runtime.lastError?l(chrome.runtime.lastError.message):r(()=>{console.log(`${e} saved`)})))}function start(){loadHostRulesFromStorage(),chrome.contextMenus.remove("t-special-block-element",()=>{chrome.runtime.lastError,chrome.contextMenus.create({title:chrome.i18n.getMessage("selectThisElement"),id:"t-special-block-element",contexts:["page","selection","link","editable","image","video","audio"]},()=>{})}),chrome.contextMenus.onClicked.addListener(onContextClick)}function stop(){removeAllRules(),chrome.declarativeNetRequest.updateEnabledRulesets({disableRulesetIds:["ruleset_1","ruleset_2","ruleset_3","ruleset_4"]}),chrome.contextMenus.remove("t-special-block-element",()=>{})}function convertOldStoredRuleToNewRule(){["rulesRemoveSelector","rulesRemoveElement"].forEach(e=>{getRulesRemove(e).then(t=>{if(t){for(let r in t){let l=t[r].split(",");l.forEach((e,t)=>{let r=e.split("|");!(r.length<3)&&(l[t]=r[0]+"|"+r[4])}),t[r]=l.join(",")}saveToChromeStorage({key:e,value:t}).finally(()=>{})}})})}function convertOldData(){convertOldStoredRuleToNewRule()}start(),chrome.runtime.onMessage.addListener((e,t,r)=>{switch(e.name){case"disable-host-block":stop();break;case"enable-host-block":chrome.declarativeNetRequest.updateEnabledRulesets({enableRulesetIds:["ruleset_1","ruleset_2","ruleset_3","ruleset_4"]}),start();break;case"update-user-host-block":isEnableExtension&&loadHostRulesFromStorage()}}),chrome.runtime.onInstalled.addListener(function(e){e.reason,start()});