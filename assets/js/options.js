let switchPageBtns=document.querySelectorAll(".btn-switch-page"),pages=document.querySelectorAll(".page"),switcherEditModes=document.querySelectorAll(".switcher-edit-mode"),saveRulesBtns=document.querySelectorAll(".btn-save-rules"),generalPageSwitchers=document.querySelectorAll(".switcher-input"),addRulesBtns=document.querySelectorAll(".btn-add-rules"),rangeUnblockLevels=document.querySelectorAll(".range-unblock-level"),importFileElement=document.querySelector(".import-file"),importRulesBtns=document.querySelectorAll(".btn-import-rules"),rulesRemovesForRender={rulesRemoveSelector:"Remove selector",rulesRemoveElement:"Remove element"},rulesRemoveAmount={rulesRemoveSelector:0,rulesRemoveElement:0},crrRuleTypeSelected="",btnsExportRules=document.querySelectorAll(".btn-export-rules"),quickSelectBlockSetting;function exportDataToJson(e,t="export.json"){let r=JSON.stringify(e),s=document.createElement("a"),l=new Blob([r],{type:"octet/stream"}),n=window.URL.createObjectURL(l);s.setAttribute("href",n),s.setAttribute("download",t),s.click()}function saveToChromeStorage({key:e,value:t}){return new Promise((r,s)=>chrome.storage.sync.set({[e]:t},()=>chrome.runtime.lastError?s(chrome.runtime.lastError.message):r(()=>{console.log(`${e} saved`)})))}function replaceStringWithMultipleValues(e,t,r){let s=e;return Array.isArray(r)?t.forEach((e,t)=>{s=s.replace(e,r[t])}):t.forEach(e=>{s=s.replace(e,r)}),s}function getFromChromeStorage(e){return new Promise((t,r)=>chrome.storage.sync.get(e,e=>chrome.runtime.lastError?r(chrome.runtime.lastError.message):t(e)))}function setAttributes(e,t){try{for(var r in t){let s=t[r];"object"==typeof s?setAttributes(e,s):e.setAttribute(r,s)}}catch(l){console.log(l)}}function addMultipleClass(e,t){try{t.forEach(t=>e.classList.add(t))}catch(r){console.log(r)}}function removeMultipleClass(e,t){try{t.forEach(t=>e.classList.remove(t))}catch(r){console.log(r)}}function showAlertMessage({title:e,message:t,type:r="info",buttons:s=[],onClose:l,timeOut:n=3e3}){let o=document.createElement("div");addMultipleClass(o,["alert","alert-"+r,"t-block-fade","show","t-spec-block-alert"]),o.innerHTML=`
        <h4>${chrome.i18n.getMessage(e)||e}</h4>
        <p>${chrome.i18n.getMessage(t)||t}</p>
    `,s&&s.forEach(e=>{let t=document.createElement("button");t.innerHTML=chrome.i18n.getMessage(e.text)||e.text,t.addEventListener("click",e.onClick),o.appendChild(t)}),document.body.appendChild(o),setTimeout(()=>{o.remove(),l&&l()},n)}function toggleClassWithCondition(e,t,r){r?t.forEach(t=>{e.classList.add(t)}):t.forEach(t=>{e.classList.remove(t)})}function setValueForGeneralSettings(e){return getFromChromeStorage("generalSettings").then(({generalSettings:t})=>{for(let r in t||(t={}),e)t[r]=e[r];return saveToChromeStorage({key:"generalSettings",value:t})})}function createRulesRemove(e,t,r,s){if(!s){let l=new Date;s=l.getHours()+":"+l.getMinutes()+" "+l.getDay()+"/"+l.getMonth()+"/"+l.getFullYear()}let n=t+s;return getRulesFromStore(r).then(s=>{if(s){let l=s[e];l?-1==l.indexOf(t)&&(l+=","+n):l=n,s[e]=l}else(s={})[e]=n;return saveToChromeStorage({key:r,value:s})})}function getRulesFromStore(e){return getFromChromeStorage(e).then(t=>t[e])}function updateOrDeleteRulesRemove(e,t,r,s){return getRulesFromStore(r).then(l=>{if(l){let n=l[e];if(n){if(n){let o=n.split(",");if(n=(o=o.filter(function(e){return!e.includes(t)})).join(","),s){let i=new Date;n+=","+t+"|"+(i.getHours()+":"+i.getMinutes()+" "+i.getDay()+"/"+i.getMonth()+"/")+i.getFullYear()}}l[e]=n}n||delete l[e]}return saveToChromeStorage({key:r,value:l})})}function createMultipleRulesRemove(e,t){return getRulesFromStore(t).then(r=>{let s=r;return e.forEach(e=>{let t=e.host,r=s[t];r?-1!=r.indexOf(e.ruleInfo)&&(s[t]+=","+e.ruleInfo):s[t]=e.ruleInfo}),saveToChromeStorage({key:t,value:s})})}function handleAssignRules(e,t){return"hostRules"!=t||Array.isArray(e)?getFromChromeStorage(t).then(r=>saveToChromeStorage({key:t,value:Object.assign(e,r)})):Promise.reject(Error("The data format is invalid"))}function removeOldActivedBtnAndPage(){switchPageBtns.forEach(e=>{e.classList.remove("active")}),pages.forEach(e=>{removeMultipleClass(e,["active","show"])})}class ElementBlockingInfo{constructor(e,t,r,s=!1,l=null){this.host=e;let n=t.split("|");this.elementQuery=n[0],this.createAt=n[4]?n[4]:"",this.removeType=r,this.isAdding=s,this.options=l,this.container=document.createElement("tr"),this.removeTypeWrapper=document.createElement("td"),this.hostWrapper=document.createElement("td"),this.elementQueryWrapper=document.createElement("td"),this.actionWrapper=document.createElement("td"),this.removeTypeSelect=document.createElement("select"),this.hostInput=document.createElement("input"),this.elementQueryInput=document.createElement("textarea"),this.saveBtn=document.createElement("button"),this.removeBtn=document.createElement("button"),this.editBtn=document.createElement("button"),this.cancelBtn=document.createElement("button"),this.init()}init(){let e;e=this.options&&this.options.mainWrapperClassName?document.querySelector("."+this.options.mainWrapperClassName):document.querySelector("."+this.removeType),this.setText(),this.actionWrapper.appendChild(this.editBtn),(!this.options||this.options.isShowRemoveBtn)&&this.actionWrapper.appendChild(this.removeBtn),this.container.appendChild(this.removeTypeWrapper),(!this.options||this.options.isShowHost)&&this.container.appendChild(this.hostWrapper),(!this.options||this.options.elementQuery)&&this.container.appendChild(this.elementQueryWrapper),this.container.appendChild(this.actionWrapper),this.isAdding?e.prepend(this.container):e.appendChild(this.container),this.hostInput.type="text",this.saveBtn.innerHTML="Save",this.removeBtn.innerHTML="Remove",this.editBtn.innerHTML="Edit",this.cancelBtn.innerHTML="Cancel",setAttributes(this.container,{"data-bs-toggle":"tooltip","data-placement":"top",title:"Created at: "+this.createAt}),this.actionWrapper.setAttribute("class","text-center"),this.saveBtn.setAttribute("class","btn btn-primary d-inline my-1"),this.removeBtn.setAttribute("class","btn btn-danger d-inline my-1"),this.editBtn.setAttribute("class","btn btn-warning d-inline my-1"),this.cancelBtn.setAttribute("class","btn btn-secondary d-inline my-1"),this.hostInput.setAttribute("class","form-control form-control-sm host-input"),this.elementQueryInput.setAttribute("class","form-control form-control-sm"),this.removeTypeSelect.setAttribute("class","form-select form-select-sm remove-type"),this.removeTypeSelect.innerHTML=`
        <option value="rulesRemoveSelector">Remove selector</option>
        <option value="rulesRemoveElement">Remove element</option>`,this.removeTypeSelect.value=this.removeType?this.removeType:"rulesRemoveSelector",this.hostInput.value=this.host?this.host:"",this.elementQueryInput.value=this.elementQuery?this.elementQuery:"",this.saveBtn.addEventListener("click",()=>{this.save()}),this.removeBtn.addEventListener("click",()=>{this.remove()}),this.editBtn.addEventListener("click",()=>{this.edit()}),this.cancelBtn.addEventListener("click",()=>{this.isAdding?this.remove():this.backToViewMode()})}edit(){this.removeTypeWrapper.innerHTML="",this.hostWrapper.innerHTML="",this.elementQueryWrapper.innerHTML="",this.actionWrapper.innerHTML="",toggleMainNavnContentSize(),this.removeTypeWrapper.appendChild(this.removeTypeSelect),this.hostWrapper.appendChild(this.hostInput),this.elementQueryWrapper.appendChild(this.elementQueryInput),this.actionWrapper.appendChild(this.saveBtn),this.actionWrapper.appendChild(this.cancelBtn),this.removeBtn.remove(),this.editBtn.remove()}save(){let e=this.removeTypeSelect.value,t=this.hostInput.value,r=this.elementQueryInput.value;if(this.options&&"function"==typeof this.options.onSave)this.options.onSave({host:t,selector:r,removeType:e});else{if(!t||!r){showAlertMessage({title:"Error",type:"danger",message:"Please fill all fields"});return}e!=this.removeType?Promise.all([updateOrDeleteRulesRemove(t,r,this.removeType),createRulesRemove(t,this.elementQuery,e,this.dateTimeCreated)]).then(()=>{this.handleSaveValue(),this.container.remove(),document.querySelector("."+e).appendChild(this.container),rulesRemoveAmount[this.removeType]=rulesRemoveAmount[this.removeType]-1,rulesRemoveAmount[e]=rulesRemoveAmount[e]+1,renderRulesFor(this.removeType)}):updateOrDeleteRulesRemove(t,r,e,!0).then(()=>{this.handleSaveValue()})}}handleSaveValue(){this.host=this.hostInput.value,this.elementQuery=this.elementQueryInput.value,this.removeType=this.removeTypeSelect.value,this.backToViewMode()}backToViewMode(){this.setText(),this.actionWrapper.appendChild(this.editBtn),(!this.options||this.options.isShowRemoveBtn)&&this.actionWrapper.appendChild(this.removeBtn),this.saveBtn.remove(),this.cancelBtn.remove(),toggleMainNavnContentSize()}remove(){this.isAdding?(this.container.remove(),renderRulesFor(this.removeType)):updateOrDeleteRulesRemove(this.host,this.elementQuery,this.removeType).then(()=>{this.container.remove(),rulesRemoveAmount[this.removeType]--,renderRulesFor(this.removeType)})}setText(){this.removeTypeWrapper.innerHTML=`<div class="table-cell-content">${rulesRemovesForRender[this.removeType]}</div>`,this.hostWrapper.innerHTML=`<div class="table-cell-content">${this.host}</div>`,this.elementQueryWrapper.innerHTML=`<div class="table-cell-content">${this.elementQuery}</div>`}}function renderRulesFor(e){return getRulesFromStore(e).then(t=>{let r=document.querySelector(".text-"+e);if(t){if("hostRules"==e)r.value=t.join("\n");else{let s=[],l=document.querySelector("."+e),n="",o=Object.keys(t);if(l.innerHTML="",o.length>0){for(let i of o)try{let a=t[i].split(",");a.length>0&&a.forEach(t=>{s.push({host:i,rule:t,rulesType:e})})}catch(c){}s.forEach(e=>{new ElementBlockingInfo(e.host,e.rule,e.rulesType),n+=createTextItemForRule(e.host,e.rule)})}rulesRemoveAmount[e]=s.length,r.value=n}}renderRuleRemoveIfEmptyRules()})}function renderRuleRemoveIfEmptyRules(){let e=document.querySelector(".rulesRemoveSelector"),t=document.querySelector(".rulesRemoveElement"),r='<td colspan="7" class="text-center table-active no-row">No data</td>';if(0==rulesRemoveAmount.rulesRemoveSelector)e.innerHTML=r;else{let s=e.querySelector(".no-row");s&&s.remove()}if(0==rulesRemoveAmount.rulesRemoveElement)t.innerHTML=r;else{let l=t.querySelector(".no-row");l&&l.remove()}}function toggleMainNavnContentSize(){toggleMultipleClass(document.querySelector(".main-navigation"),["col-md-3","col-md-2"]),toggleMultipleClass(document.querySelector(".main-content"),["col-md-9","col-md-10"])}function toggleMultipleClass(e,t){t.forEach(t=>{e.classList.toggle(t)})}function renderGeneralSetting(){getFromChromeStorage("generalSettings").then(({generalSettings:e})=>{e||(e={});let t=e.isEnableDialog,r=e.isEnableAutoUnblockCopy,s=e.isEnableAutoUnblockScroll,l=document.querySelector(".set-default-quick-select"),n=document.querySelector(".select-level-unblock-copy-wrapper"),o=document.querySelector(".select-level-unblock-scroll-wrapper"),i=e.selectorOptions?e.selectorOptions:"",a=e.quickRemoveType?e.quickRemoveType:"",c=generalPageSwitchers[0],u=generalPageSwitchers[1],h=rangeUnblockLevels[0],p=generalPageSwitchers[2],d=rangeUnblockLevels[1];c.checked=t,u.checked=r,p.checked=s,h.value=e.unblockCopyLevel,d.value=e.unblockScrollLevel,document.querySelector(".quick-select-option").innerHTML="",quickSelectBlockSetting=new ElementBlockingInfo("",i,a,!1,{isShowRemoveBtn:!1,mainWrapperClassName:"quick-select-option",onSave({removeType:e}){setValueForGeneralSettings({quickRemoveType:e}).then(()=>{quickSelectBlockSetting.handleSaveValue()})}}),toggleClassWithCondition(l,["disabled-all"],t),toggleClassWithCondition(n,["disabled-all"],!r),toggleClassWithCondition(o,["disabled-all"],!s)})}function createTextItemForRule(e,t){let r=t.split("|"),s=r[0];return"---------------------------\n@host: "+e+"\n@createAt: "+("undefined"!==r[1]?r[1]:"")+"\n@selector: "+s+"\n"}function textToRule(e){let t=e.split("---------------------------");t.shift();let r=[];return t.forEach(e=>{let t=e.split("\n"),s=t[1].split("@host: ")[1],l=t[2].split("@createAt: ")[1],n=t[3].split("@selector: ")[1];s&&n&&r.push({host:s,ruleInfo:n+"|"+l})}),r}function sendMessage(e){chrome.runtime.sendMessage(e)}chrome.runtime.onMessage.addListener(function(e,t,r){switch(e.name){case"updateRules":renderRulesFor(e.selectorType);break;case"unblock-scroll":case"unblock-copy":renderGeneralSetting()}}),renderGeneralSetting(),renderRulesFor("rulesRemoveElement"),renderRulesFor("rulesRemoveSelector"),renderRulesFor("hostRules"),switchPageBtns.forEach((e,t)=>{e.addEventListener("click",()=>{removeOldActivedBtnAndPage(),switchPageBtns[t].classList.add("active"),addMultipleClass(pages[t],["active","show"])})}),switcherEditModes.forEach(e=>{e.addEventListener("click",e=>{let t=e.target,r=t.checked,s=t.getAttribute("for-rule"),l=document.querySelector(`.textarea-${s}`),n=document.querySelector(`.table-${s}-wrapper`);r?(l.classList.remove("d-none"),n.classList.add("d-none")):(l.classList.add("d-none"),n.classList.remove("d-none"))})}),addRulesBtns.forEach(e=>{e.addEventListener("click",()=>{let t=e.getAttribute("for-rules");new ElementBlockingInfo("","",t,!0).edit()})}),generalPageSwitchers.forEach(e=>{e.addEventListener("change",e=>{let t=e.target,r=t.checked,s=t.getAttribute("toggle-el");setValueForGeneralSettings({[t.getAttribute("general-attr")]:r}).then(()=>{document.querySelector("."+s).classList.toggle("disabled-all")})})}),rangeUnblockLevels.forEach(e=>{e.addEventListener("change",e=>{let t=e.target,r=t.value,s=t.getAttribute("unblock-for");setValueForGeneralSettings({[s]:r}),document.querySelector(".level-selected-"+s).innerHTML=r})}),saveRulesBtns.forEach(e=>{e.addEventListener("click",e=>{let t=e.target.getAttribute("for-rules"),r=document.querySelector(".text-"+t).value;if("hostRules"==t)handleAssignRules(r.split("\n"),t).then(()=>{showAlertMessage({title:"Success",type:"success",message:"Saved successfully"}),sendMessage({name:"update-user-host-block"}),renderRulesFor(t)}).catch(e=>{console.log(e),showAlertMessage({title:"Error",type:"danger",message:e})});else{let s=textToRule(r);0==s.length?showAlertMessage({title:"Error",type:"danger",message:"The rules are not valid"}):createMultipleRulesRemove(s,t).then(()=>{showAlertMessage({title:"Success",type:"success",message:"Saved successfully"}),renderRulesFor(t)}).catch(()=>{showAlertMessage({title:"Error",type:"danger",message:"Error while saving"})})}})}),btnsExportRules.forEach(e=>{e.addEventListener("click",e=>{let t=e.target.getAttribute("for-rules");getFromChromeStorage(t).then(e=>{e[t]?exportDataToJson(e[t],t+".json"):showAlertMessage({title:"Error",type:"danger",message:"There is no defination data of this rule"})})})}),importRulesBtns.forEach(e=>{e.addEventListener("click",e=>{let t=e.target.getAttribute("for-rules");importFileElement.setAttribute("for-rule",t),importFileElement.click()})}),importFileElement.addEventListener("change",e=>{let t=importFileElement.files[0];if(t){let r=new FileReader;function s(e){let t=JSON.parse(e.target.result),r=importFileElement.getAttribute("for-rule");r&&handleAssignRules(t,r).then(()=>{showAlertMessage({title:"Success",type:"success",message:"Import successfully"}),importFileElement.value="","hostRules"==r&&sendMessage({name:"update-user-host-block"}),renderRulesFor(r)}).catch(e=>{console.log(e),showAlertMessage({title:"Error",type:"danger",message:"Import failed"}),importFileElement.value=""})}r.onload=s,r.readAsText(t)}});const supportedLanguages=["en","vi"];async function applyTranslationsToDOM(e){document.documentElement.lang=e;try{let t=await fetch(`/_locales/${e}/messages.json`);if(!t.ok){console.error(`Could not load messages for ${e}. Status: ${t.status}`),e!==defaultLang?(console.warn(`Falling back to ${defaultLang} messages.`),await applyTranslationsToDOM(defaultLang)):currentLocaleMessages={};return}currentLocaleMessages=await t.json()}catch(r){console.error(`Error fetching messages for ${e}:`,r),e!==defaultLang?(console.warn(`Falling back to ${defaultLang} messages due to fetch error.`),await applyTranslationsToDOM(defaultLang)):currentLocaleMessages={};return}function s(e,t){let r=currentLocaleMessages[e];if(!r||!r.message)return chrome.i18n.getMessage(e,t)||e;let s=r.message;if(t){if(r.placeholders){for(let l in r.placeholders)if(r.placeholders.hasOwnProperty(l)){let n=r.placeholders[l].content,o=parseInt(n.substring(1),10)-1;Array.isArray(t)&&o<t.length?s=(s=s.replace(RegExp(`\\$${l}\\$`,"gi"),t[o])).replace(n,t[o]):"string"==typeof t&&0===o&&(s=(s=s.replace(RegExp(`\\$${l}\\$`,"gi"),t)).replace(n,t))}}else if(Array.isArray(t))for(let i=0;i<t.length;i++)s=s.replace("$"+(i+1)+"$",t[i]);else"string"==typeof t&&(s=s.replace("$1$",t))}return s}let l=document.querySelectorAll("[data-i18n]");l.forEach(e=>{let t=e.dataset.i18n,r=s(t);if("INPUT"===e.tagName&&("button"===e.type||"submit"===e.type||"reset"===e.type))e.value=r;else if("INPUT"===e.tagName&&e.hasAttribute("placeholder")&&"true"===e.dataset.i18nPlaceholder)e.placeholder=r;else if(e.hasAttribute("title")&&"true"===e.dataset.i18nTitle)e.title=r;else{e.childNodes.forEach(e=>{e.nodeType!==Node.TEXT_NODE&&e.nodeType!==Node.COMMENT_NODE&&"I"===e.tagName&&e.classList.contains("fas")});{let l=null;for(let n=0;n<e.childNodes.length;n++){let o=e.childNodes[n];if(o.nodeType===Node.TEXT_NODE&&""!==o.textContent.trim()){l=o;break}if(o.nodeType===Node.ELEMENT_NODE&&"SPAN"===o.tagName&&1===o.childNodes.length&&o.childNodes[0].nodeType===Node.TEXT_NODE){l=o.childNodes[0];break}}if(l)l.textContent=r;else if(e.children.length>0){let i=e.querySelector("span.text-uppercase");i?i.textContent=r:e.lastChild.textContent=r}else e.textContent=r}}}),rulesRemovesForRender.rulesRemoveSelector=s("removeSelectorType"),rulesRemovesForRender.rulesRemoveElement=s("removeElementType"),renderRulesFor("rulesRemoveElement"),renderRulesFor("rulesRemoveSelector"),renderRulesFor("hostRules"),renderGeneralSetting(),document.querySelectorAll(".table-rules tbody tr").forEach(e=>{let t=e.querySelector(".btn-primary"),r=e.querySelector(".btn-danger"),l=e.querySelector(".btn-warning"),n=e.querySelector(".btn-secondary");t&&(t.textContent=s("saveButton")),r&&(r.textContent=s("removeButton")),l&&(l.textContent=s("editButton")),n&&(n.textContent=s("cancelButton"));let o=e.getAttribute("data-original-title")||e.getAttribute("title");if(o&&o.startsWith(s("createdAtTooltip",[""]).split(":")[0])){let i=o.split(": ")[1];i&&e.setAttribute("title",s("createdAtTooltip",[i]))}}),document.querySelectorAll(".table-rules th[data-i18n]").forEach(e=>{e.textContent=s(e.dataset.i18n)}),renderRuleRemoveIfEmptyRules()}async function initializeLanguage(){let e=document.getElementById("language-selector"),{userSelectedLang:t}=await chrome.storage.sync.get("userSelectedLang"),r=t||chrome.i18n.getUILanguage().split("-")[0];supportedLanguages.includes(r)||(r="en"),e&&(e.value=r),await applyTranslationsToDOM(r),e&&e.addEventListener("change",async e=>{let t=e.target.value;await chrome.storage.sync.set({userSelectedLang:t}),window.location.reload()})}document.addEventListener("DOMContentLoaded",initializeLanguage);