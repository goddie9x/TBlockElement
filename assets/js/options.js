let switchPageBtns=document.querySelectorAll(".btn-switch-page"),pages=document.querySelectorAll(".page"),switcherEditModes=document.querySelectorAll(".switcher-edit-mode"),saveRulesBtns=document.querySelectorAll(".btn-save-rules"),genaralPageSwitchers=document.querySelectorAll(".switcher-input"),addRulesBtns=document.querySelectorAll(".btn-add-rules"),rangeUnblockLevels=document.querySelectorAll(".range-unblock-level"),importFileElement=document.querySelector(".import-file"),importRulesBtns=document.querySelectorAll(".btn-import-rules"),rulesRemovesForRender={rulesRemoveSelector:"Remove selector",rulesRemoveElement:"Remove element"},rulesRemoveAmount={rulesRemoveSelector:0,rulesRemoveElement:0},crrRuleTypeSelected="",btnsExportRules=document.querySelectorAll(".btn-export-rules"),quickSelectBlockSetting;const selectTypes=["interval","timeout","onscroll","onload","DOMNodeInserted"];function exportDataToJson(e,t="export.json"){let l=JSON.stringify(e),n=document.createElement("a"),r=new Blob([l],{type:"octet/stream"}),s=window.URL.createObjectURL(r);n.setAttribute("href",s),n.setAttribute("download",t),n.click()}function saveToChromeStorage({key:e,value:t}){return new Promise((l,n)=>chrome.storage.sync.set({[e]:t},()=>chrome.runtime.lastError?n(chrome.runtime.lastError.message):l(()=>{console.log(`${e} saved`)})))}function replaceStringWithMultipleValues(e,t,l){let n=e;return Array.isArray(l)?t.forEach((e,t)=>{n=n.replace(e,l[t])}):t.forEach(e=>{n=n.replace(e,l)}),n}function getFromChromeStorage(e){return new Promise((t,l)=>chrome.storage.sync.get(e,e=>chrome.runtime.lastError?l(chrome.runtime.lastError.message):t(e)))}function setAttributes(e,t){try{for(var l in t){let n=t[l];"object"==typeof n?setAttributes(e,n):e.setAttribute(l,n)}}catch(r){console.log(r)}}function addMultipleClass(e,t){try{t.forEach(t=>e.classList.add(t))}catch(l){console.log(l)}}function removeMultipleClass(e,t){try{t.forEach(t=>e.classList.remove(t))}catch(l){console.log(l)}}function showAlertMessage({title:e,message:t,type:l="info",buttons:n=[],onClose:r,timeOut:s=3e3}){let i=document.createElement("div");addMultipleClass(i,["alert","alert-"+l,"fade","show","t-spec-block-alert"]),i.innerHTML=`
        <h4>${e}</h4>
        <p>${t}</p>
    `,n&&n.forEach(e=>{let t=document.createElement("button");t.innerHTML=e.text,t.addEventListener("click",e.onClick),i.appendChild(t)}),document.body.appendChild(i),setTimeout(()=>{i.remove(),r&&r()},s)}function toggleClassWithCondition(e,t,l){l?t.forEach(t=>{e.classList.add(t)}):t.forEach(t=>{e.classList.remove(t)})}function setValueForGeneralSettings(e){return getFromChromeStorage("generalSetings").then(({generalSetings:t})=>{for(let l in t||(t={}),e)t[l]=e[l];return saveToChromeStorage({key:"generalSetings",value:t})})}function createRulesRemove(e,{selector:t,method:l,timeInterval:n,amountLoop:r},s,i){if(n=n||"",r=r||"",!i){let o=new Date;i=o.getHours()+":"+o.getMinutes()+" "+o.getDay()+"/"+o.getMonth()+"/"+o.getFullYear()}let a=t+"|"+l+"|"+n+"|"+r+"|"+i;return getRulesFromStore(s).then(t=>{if(t){let l=t[e];l?-1==l.indexOf(a)&&(l+=","+a):l=a,t[e]=l}else(t={})[e]=a;return saveToChromeStorage({key:s,value:t})})}function getRulesFromStore(e){return getFromChromeStorage(e).then(t=>t[e])}function updateOrDeleteRulesRemove(e,{selector:t,method:l,timeInterval:n,amountLoop:r},s,i){let o=t+"|"+l+"|"+(n=n||"")+"|"+(r=r||"");return getRulesFromStore(s).then(t=>{if(t){let l=t[e];if(l){if(l){let n=l.split(",");if(l=(n=n.filter(function(e){return!e.includes(o)})).join(","),i){let r=new Date;l+=","+o+"|"+(r.getHours()+":"+r.getMinutes()+" "+r.getDay()+"/"+r.getMonth()+"/")+r.getFullYear()}}t[e]=l}l||delete t[e]}return saveToChromeStorage({key:s,value:t})})}function createMultipleRulesRemove(e,t){return getRulesFromStore(t).then(l=>{let n=l;return e.forEach(e=>{let t=e.host,l=n[t];l?-1!=l.indexOf(e.ruleInfo)&&(n[t]+=","+e.ruleInfo):n[t]=e.ruleInfo}),saveToChromeStorage({key:t,value:n})})}function handleAssignRules(e,t){return"hostRules"!=t||Array.isArray(e)?getFromChromeStorage(t).then(l=>saveToChromeStorage({key:t,value:Object.assign(e,l)})):Promise.reject(Error("The data format is invalid"))}function removeOldActivedBtnAndPage(){switchPageBtns.forEach(e=>{e.classList.remove("active")}),pages.forEach(e=>{removeMultipleClass(e,["active","show"])})}class ElementBlockingInfo{constructor(e,t,l,n=!1,r=null){this.host=e;let s=t.split("|");this.elementQuery=s[0],this.elementType=s[1],this.elementTime=s[2]?s[2]:"",this.elementSpecialTime=s[3]?s[3]:"",this.createAt=s[4]?s[4]:"",this.removeType=l,this.isAdding=n,this.options=r,this.container=document.createElement("tr"),this.removeTypeWrapper=document.createElement("td"),this.hostWrapper=document.createElement("td"),this.elementQueryWrapper=document.createElement("td"),this.elementTypeWrapper=document.createElement("td"),this.elementTimeWrapper=document.createElement("td"),this.elementSpecialTimeWrapper=document.createElement("td"),this.actionWrapper=document.createElement("td"),this.removeTypeSelect=document.createElement("select"),this.hostInput=document.createElement("input"),this.elementQueryInput=document.createElement("textarea"),this.elementTypeSelect=document.createElement("select"),this.elementTimeInput=document.createElement("input"),this.elementSpecialTimeInput=document.createElement("input"),this.saveBtn=document.createElement("button"),this.removeBtn=document.createElement("button"),this.editBtn=document.createElement("button"),this.cancelBtn=document.createElement("button"),this.init()}init(){let e;e=this.options&&this.options.mainWrapperClassName?document.querySelector("."+this.options.mainWrapperClassName):document.querySelector("."+this.removeType),this.setText(),this.actionWrapper.appendChild(this.editBtn),(!this.options||this.options.isShowRemoveBtn)&&this.actionWrapper.appendChild(this.removeBtn),this.container.appendChild(this.removeTypeWrapper),(!this.options||this.options.isShowHost)&&this.container.appendChild(this.hostWrapper),(!this.options||this.options.elementQuery)&&this.container.appendChild(this.elementQueryWrapper),this.container.appendChild(this.elementTypeWrapper),this.container.appendChild(this.elementTimeWrapper),this.container.appendChild(this.elementSpecialTimeWrapper),this.container.appendChild(this.actionWrapper),this.isAdding?e.prepend(this.container):e.appendChild(this.container),this.hostInput.type="text",this.elementTimeInput.type="number",this.elementSpecialTimeInput.type="number",this.saveBtn.innerHTML="Save",this.removeBtn.innerHTML="Remove",this.editBtn.innerHTML="Edit",this.cancelBtn.innerHTML="Cancel",setAttributes(this.container,{"data-bs-toggle":"tooltip","data-placement":"top",title:"Created at: "+this.createAt}),this.actionWrapper.setAttribute("class","text-center"),this.saveBtn.setAttribute("class","btn btn-primary d-inline my-1"),this.removeBtn.setAttribute("class","btn btn-danger d-inline my-1"),this.editBtn.setAttribute("class","btn btn-warning d-inline my-1"),this.cancelBtn.setAttribute("class","btn btn-secondary d-inline my-1"),this.hostInput.setAttribute("class","form-control form-control-sm host-input"),this.elementQueryInput.setAttribute("class","form-control form-control-sm"),this.elementTimeInput.setAttribute("class","form-control form-control-sm interval-time-input"),this.elementSpecialTimeInput.setAttribute("class","form-control form-control-sm loop-times-input"),this.removeTypeSelect.setAttribute("class","form-select form-select-sm remove-type"),this.elementTypeSelect.setAttribute("class","form-select form-select-sm method-type"),this.removeTypeSelect.innerHTML=`
        <option value="rulesRemoveSelector">Remove selector</option>
        <option value="rulesRemoveElement">Remove element</option>`,this.elementTypeSelect.innerHTML=selectTypes.map(e=>`<option value="${e}">${e}</option>`).join(""),this.removeTypeSelect.value=this.removeType?this.removeType:"rulesRemoveSelector",this.hostInput.value=this.host?this.host:"",this.elementQueryInput.value=this.elementQuery?this.elementQuery:"",this.elementTypeSelect.value=this.elementType?this.elementType:selectTypes[0],this.elementTimeInput.value=this.elementTime,this.elementSpecialTimeInput.value=this.elementSpecialTime,this.elementTypeSelect.addEventListener("change",e=>{let t=e.target.value;"interval"==t||"timeout"==t?(this.elementSpecialTimeWrapper.appendChild(this.elementTimeInput),"interval"==t?this.elementTimeWrapper.appendChild(this.elementSpecialTimeInput):this.elementSpecialTimeInput.remove()):(this.elementSpecialTimeInput.remove(),this.elementTimeInput.remove())}),this.saveBtn.addEventListener("click",()=>{this.save()}),this.removeBtn.addEventListener("click",()=>{this.remove()}),this.editBtn.addEventListener("click",()=>{this.edit()}),this.cancelBtn.addEventListener("click",()=>{this.isAdding?this.remove():this.backToViewMode()})}edit(){let e=this.elementTypeSelect.value;this.removeTypeWrapper.innerHTML="",this.hostWrapper.innerHTML="",this.elementQueryWrapper.innerHTML="",this.elementTypeWrapper.innerHTML="",this.elementTimeWrapper.innerHTML="",this.elementSpecialTimeWrapper.innerHTML="",this.actionWrapper.innerHTML="",toggleMainNavnContentSize(),this.removeTypeWrapper.appendChild(this.removeTypeSelect),this.hostWrapper.appendChild(this.hostInput),this.elementQueryWrapper.appendChild(this.elementQueryInput),this.elementTypeWrapper.appendChild(this.elementTypeSelect),("interval"==e||"timeout"==e)&&(this.elementTimeWrapper.appendChild(this.elementTimeInput),"interval"==e&&this.elementSpecialTimeWrapper.appendChild(this.elementSpecialTimeInput)),this.actionWrapper.appendChild(this.saveBtn),this.actionWrapper.appendChild(this.cancelBtn),this.removeBtn.remove(),this.editBtn.remove()}save(){let e=this.removeTypeSelect.value,t=this.hostInput.value,l=this.elementQueryInput.value,n=this.elementTypeSelect.value,r=this.elementTimeInput.value,s=this.elementSpecialTimeInput.value;if(this.options&&"function"==typeof this.options.onSave)this.options.onSave({host:t,selector:l,method:n,timeInterval:r,amountLoop:s,removeType:e});else{if(!t||!l||!n){showAlertMessage({title:"Error",type:"danger",message:"Please fill all fields"});return}e!=this.removeType?Promise.all([updateOrDeleteRulesRemove(t,{selector:l,selector:l,method:n,timeInterval:r,amountLoop:s},this.removeType),createRulesRemove(t,{selector:this.elementQuery,selector:this.elementQuery,method:this.elementType,timeInterval:this.elementTime,amountLoop:this.elementSpecialTime},e)]).then(()=>{this.handleSaveValue(),this.container.remove(),document.querySelector("."+e).appendChild(this.container),rulesRemoveAmount[this.removeType]=rulesRemoveAmount[this.removeType]-1,rulesRemoveAmount[e]=rulesRemoveAmount[e]+1,renderRulesFor(this.removeType)}):updateOrDeleteRulesRemove(t,{selector:l,selector:l,method:n,timeInterval:r,amountLoop:s},e,!0).then(()=>{this.handleSaveValue()})}}handleSaveValue(){this.host=this.hostInput.value,this.elementQuery=this.elementQueryInput.value,this.elementType=this.elementTypeSelect.value,this.elementTime=this.elementTimeInput.value,this.elementSpecialTime=this.elementSpecialTimeInput.value,this.removeType=this.removeTypeSelect.value,this.backToViewMode()}backToViewMode(){this.setText(),this.actionWrapper.appendChild(this.editBtn),this.actionWrapper.appendChild(this.removeBtn),this.saveBtn.remove(),this.cancelBtn.remove(),toggleMainNavnContentSize()}remove(){this.isAdding?(this.container.remove(),renderRulesFor(this.removeType)):updateOrDeleteRulesRemove(this.host,{selector:this.elementQuery,method:this.elementType,timeInterval:this.elementTime,amountLoop:this.elementSpecialTime},this.removeType).then(()=>{this.container.remove(),rulesRemoveAmount[this.removeType]--,renderRulesFor(this.removeType)})}setText(){this.removeTypeWrapper.innerHTML=`<div class="table-cell-content">${rulesRemovesForRender[this.removeType]}</div>`,this.hostWrapper.innerHTML=`<div class="table-cell-content">${this.host}</div>`,this.elementQueryWrapper.innerHTML=`<div class="table-cell-content">${this.elementQuery}</div>`,this.elementTypeWrapper.innerHTML="undefined"!=this.elementType?`<div class="table-cell-content">${this.elementType}</div>`:"",this.elementTimeWrapper.innerHTML="undefined"!=this.elementTime?`<div class="table-cell-content">${this.elementTime}</div>`:"",this.elementSpecialTimeWrapper.innerHTML="undefined"!=this.elementSpecialTime?`<div class="table-cell-content">${this.elementSpecialTime}</div>`:""}}function renderRulesFor(e){return getRulesFromStore(e).then(t=>{let l=document.querySelector(".text-"+e);if(t){if("hostRules"==e)l.value=t.join("\n");else{let n=[],r=document.querySelector("."+e),s="",i=Object.keys(t);if(r.innerHTML="",i.length>0){for(let o of i)try{let a=t[o].split(",");a.length>0&&a.forEach(t=>{n.push({host:o,rule:t,rulesType:e})})}catch(c){}n.forEach(e=>{new ElementBlockingInfo(e.host,e.rule,e.rulesType),s+=createTextItemForRule(e.host,e.rule)})}rulesRemoveAmount[e]=n.length,l.value=s}}renderRuleRemoveIfEmptyRules()})}function renderRuleRemoveIfEmptyRules(){let e=document.querySelector(".rulesRemoveSelector"),t=document.querySelector(".rulesRemoveElement"),l='<td colspan="7" class="text-center table-active no-row">No data</td>';if(0==rulesRemoveAmount.rulesRemoveSelector)e.innerHTML=l;else{let n=e.querySelector(".no-row");n&&n.remove()}if(0==rulesRemoveAmount.rulesRemoveElement)t.innerHTML=l;else{let r=t.querySelector(".no-row");r&&r.remove()}}function toggleMainNavnContentSize(){toggleMultipleClass(document.querySelector(".main-navigation"),["col-md-3","col-md-2"]),toggleMultipleClass(document.querySelector(".main-content"),["col-md-9","col-md-10"])}function toggleMultipleClass(e,t){t.forEach(t=>{e.classList.toggle(t)})}function renderGeneralSeting(){getFromChromeStorage("generalSetings").then(({generalSetings:e})=>{e||(e={});let t=e.isEnableDialog,l=e.isEnableAutoUnblockCopy,n=e.isEnableAutoUnblockScroll,r=document.querySelector(".set-default-quick-select"),s=document.querySelector(".select-level-unblock-copy-wrapper"),i=document.querySelector(".select-level-unblock-scroll-wrapper"),o=e.selectorOptions?e.selectorOptions:"",a=e.quickRemoveType?e.quickRemoveType:"",c=genaralPageSwitchers[0],m=genaralPageSwitchers[1],h=rangeUnblockLevels[0],u=genaralPageSwitchers[2],p=rangeUnblockLevels[1];c.checked=t,m.checked=l,u.checked=n,h.value=e.unblockCopyLevel,p.value=e.unblockScrollLevel,document.querySelector(".quick-select-option").innerHTML="",quickSelectBlockSetting=new ElementBlockingInfo("",o,a,!1,{isShowRemoveBtn:!0,mainWrapperClassName:"quick-select-option",onSave({method:e,timeInterval:t,amountLoop:l,removeType:n}){setValueForGeneralSettings({quickRemoveType:n,selectorOptions:n+"|"+e+"|"+t+"|"+l}).then(()=>{quickSelectBlockSetting.handleSaveValue()})}}),toggleClassWithCondition(r,["disabled-all"],t),toggleClassWithCondition(s,["disabled-all"],!l),toggleClassWithCondition(i,["disabled-all"],!n)})}function createTextItemForRule(e,t){let l=t.split("|"),n=l[0],r=l[1],s="undefined"!==l[2]?l[2]:"",i="undefined"!==l[3]?l[3]:"";return"---------------------------\n@host: "+e+"\n@createAt: "+("undefined"!==l[4]?l[4]:"")+"\n@selector: "+n+"\n@block method: "+r+"\n@time Interval: "+s+"\n@times loop: "+i+"\n"}function textToRule(e){let t=e.split("---------------------------");t.shift();let l=[];return t.forEach(e=>{let t=e.split("\n"),n=t[1].split("@host: ")[1],r=t[2].split("@createAt: ")[1],s=t[3].split("@selector: ")[1],i=t[4].split("@block method: ")[1],o=t[5].split("@time Interval: ")[1],a=t[6].split("@times loop: ")[1];n&&s&&i&&l.push({host:n,ruleInfo:s+"|"+i+"|"+o+"|"+a+"|"+r})}),l}function sendMessage(e){chrome.runtime.sendMessage(e)}chrome.runtime.onMessage.addListener(function(e,t,l){switch(e.name){case"updateRules":renderRulesFor(e.selectorType);break;case"unblock-scroll":case"unblock-copy":renderGeneralSeting()}}),renderGeneralSeting(),renderRulesFor("rulesRemoveElement"),renderRulesFor("rulesRemoveSelector"),renderRulesFor("hostRules"),switchPageBtns.forEach((e,t)=>{e.addEventListener("click",()=>{removeOldActivedBtnAndPage(),switchPageBtns[t].classList.add("active"),addMultipleClass(pages[t],["active","show"])})}),switcherEditModes.forEach(e=>{e.addEventListener("click",e=>{let t=e.target,l=t.checked,n=t.getAttribute("for-rule"),r=document.querySelector(`.textarea-${n}`),s=document.querySelector(`.table-${n}-wrapper`);l?(r.classList.remove("d-none"),s.classList.add("d-none")):(r.classList.add("d-none"),s.classList.remove("d-none"))})}),addRulesBtns.forEach(e=>{e.addEventListener("click",()=>{let t=e.getAttribute("for-rules");new ElementBlockingInfo("","",t,!0).edit()})}),genaralPageSwitchers.forEach(e=>{e.addEventListener("change",e=>{let t=e.target,l=t.checked,n=t.getAttribute("toggle-el");setValueForGeneralSettings({[t.getAttribute("general-attr")]:l}).then(()=>{document.querySelector("."+n).classList.toggle("disabled-all")})})}),rangeUnblockLevels.forEach(e=>{e.addEventListener("change",e=>{let t=e.target,l=t.value,n=t.getAttribute("unblock-for");setValueForGeneralSettings({[n]:l}),document.querySelector(".level-selected-"+n).innerHTML=l})}),saveRulesBtns.forEach(e=>{e.addEventListener("click",e=>{let t=e.target.getAttribute("for-rules"),l=document.querySelector(".text-"+t).value;if("hostRules"==t)handleAssignRules(l.split("\n"),t).then(()=>{showAlertMessage({title:"Success",type:"success",message:"Saved successfully"}),sendMessage({name:"update-user-host-block"}),renderRulesFor(t)}).catch(e=>{console.log(e),showAlertMessage({title:"Error",type:"danger",message:e})});else{let n=textToRule(l);0==n.length?showAlertMessage({title:"Error",type:"danger",message:"The rules are not valid"}):createMultipleRulesRemove(n,t).then(()=>{showAlertMessage({title:"Success",type:"success",message:"Saved successfully"}),renderRulesFor(t)}).catch(()=>{showAlertMessage({title:"Error",type:"danger",message:"Error while saving"})})}})}),btnsExportRules.forEach(e=>{e.addEventListener("click",e=>{let t=e.target.getAttribute("for-rules");getFromChromeStorage(t).then(e=>{e[t]?exportDataToJson(e[t],t+".json"):showAlertMessage({title:"Error",type:"danger",message:"There is no defination data of this rule"})})})}),importRulesBtns.forEach(e=>{e.addEventListener("click",e=>{let t=e.target.getAttribute("for-rules");importFileElement.setAttribute("for-rule",t),importFileElement.click()})}),importFileElement.addEventListener("change",e=>{let t=importFileElement.files[0];if(t){let l=new FileReader;function n(e){let t=JSON.parse(e.target.result),l=importFileElement.getAttribute("for-rule");l&&handleAssignRules(t,l).then(()=>{showAlertMessage({title:"Success",type:"success",message:"Import successfully"}),importFileElement.value="","hostRules"==l&&sendMessage({name:"update-user-host-block"}),renderRulesFor(l)}).catch(e=>{console.log(e),showAlertMessage({title:"Error",type:"danger",message:"Import failed"}),importFileElement.value=""})}l.onload=n,l.readAsText(t)}});