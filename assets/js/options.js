let switchPageBtns=document.querySelectorAll(".btn-switch-page"),pages=document.querySelectorAll(".page"),switcherEditModes=document.querySelectorAll(".switcher-edit-mode"),saveRulesBtns=document.querySelectorAll(".btn-save-rules"),genaralPageSwitchers=document.querySelectorAll(".switcher-input"),addRulesBtns=document.querySelectorAll(".btn-add-rules"),rangeUnblockLevels=document.querySelectorAll(".range-unblock-level"),rulesRemovesForRender={rulesRemoveSelector:"Remove selector",rulesRemoveElement:"Remove element"},rulesRemoveAmount={rulesRemoveSelector:0,rulesRemoveElement:0},quickSelectBlockSetting;const selectTypes=["interval","timeout","onscroll","onload"];function saveToChromeStorage({key:a,value:b}){return new Promise((c,d)=>chrome.storage.sync.set({[a]:b},()=>chrome.runtime.lastError?d(chrome.runtime.lastError.message):c(()=>{console.log(`${a} saved`)})))}function replaceStringWithMultipleValues(b,a,c){let d=b;return Array.isArray(c)?a.forEach((a,b)=>{d=d.replace(a,c[b])}):a.forEach(a=>{d=d.replace(a,c)}),d}function getFromChromeStorage(a){return new Promise((b,c)=>chrome.storage.sync.get(a,a=>chrome.runtime.lastError?c(chrome.runtime.lastError.message):b(a)))}function setAttributes(b,c){try{for(var d in c){let a=c[d];"object"==typeof a?setAttributes(b,a):b.setAttribute(d,a)}}catch(e){console.log(e)}}function addMultipleClass(c,a){try{a.forEach(a=>c.classList.add(a))}catch(b){console.log(b)}}function removeMultipleClass(c,a){try{a.forEach(a=>c.classList.remove(a))}catch(b){console.log(b)}}function showAlertMessage({title:c,message:d,type:e="info",buttons:b=[],onClose:g,timeOut:f=3e3}){let a=document.createElement("div");addMultipleClass(a,["alert","alert-"+e,"fade","show","t-spec-block-alert"]),a.innerHTML=`
        <h4>${c}</h4>
        <p>${d}</p>
    `,b&&b.forEach(c=>{let b=document.createElement("button");b.innerHTML=c.text,b.addEventListener("click",c.onClick),a.appendChild(b)}),document.body.appendChild(a),setTimeout(()=>{a.remove(),g&&g()},f)}function toggleClassWithCondition(c,a,b){b?a.forEach(a=>{c.classList.add(a)}):a.forEach(a=>{c.classList.remove(a)})}function setValueForGeneralSettings(a){return getFromChromeStorage("generalSetings").then(({generalSetings:b})=>{for(let c in b||(b={}),a)b[c]=a[c];return saveToChromeStorage({key:"generalSetings",value:b})})}function createRulesRemove(h,{selector:e,method:f,timeInterval:b,amountLoop:c},g,d){if(b=b||"",c=c||"",!d){let a=new Date;d=a.getHours()+":"+a.getMinutes()+" "+a.getDay()+"/"+a.getMonth()+"/"+a.getFullYear()}let i=e+"|"+f+"|"+b+"|"+c+"|"+d;return getRulesRemove(g).then(a=>{if(a){let b=a[h];b?-1==b.indexOf(i)&&(b+=","+i):b=i,a[h]=b}else(a={})[h]=i;return saveToChromeStorage({key:g,value:a})})}function getRulesRemove(a){return("rulesRemoveElement"==a?getFromChromeStorage("rulesRemoveElement"):getFromChromeStorage("rulesRemoveSelector")).then(b=>b[a])}function updateOrDeleteRulesRemove(f,{selector:c,method:d,timeInterval:a,amountLoop:b},e,g){a=a||"",b=b||"";let h=c+"|"+d+"|"+a+"|"+b;return getRulesRemove(e).then(b=>{if(b){let a=b[f];if(a){if(a){let d=a.split(",");if(a=(d=d.filter(function(a){return!a.includes(h)})).join(","),g){let c=new Date;a+=","+h+"|"+(c.getHours()+":"+c.getMinutes()+" "+c.getDay()+"/"+c.getMonth()+"/"+c.getFullYear())}}b[f]=a}a||delete b[f]}return saveToChromeStorage({key:e,value:b})})}function createMultipleRulesRemove(b,a){return getRulesRemove(a).then(c=>{let d=c;return b.forEach(a=>{let b=a.host,c=d[b];c?-1!=c.indexOf(a.ruleInfo)&&(d[b]+=","+a.ruleInfo):d[b]=a.ruleInfo}),saveToChromeStorage({key:a,value:d})})}function removeOldActivedBtnAndPage(){switchPageBtns.forEach(a=>{a.classList.remove("active")}),pages.forEach(a=>{removeMultipleClass(a,["active","show"])})}class ElementBlockingInfo{constructor(b,c,d,e=!1,f=null){this.host=b;let a=c.split("|");this.elementQuery=a[0],this.elementType=a[1],this.elementTime=a[2]?a[2]:"",this.elementSpecialTime=a[3]?a[3]:"",this.createAt=a[4]?a[4]:"",this.removeType=d,this.isAdding=e,this.options=f,this.container=document.createElement("tr"),this.removeTypeWrapper=document.createElement("td"),this.hostWrapper=document.createElement("td"),this.elementQueryWrapper=document.createElement("td"),this.elementTypeWrapper=document.createElement("td"),this.elementTimeWrapper=document.createElement("td"),this.elementSpecialTimeWrapper=document.createElement("td"),this.actionWrapper=document.createElement("td"),this.removeTypeSelect=document.createElement("select"),this.hostInput=document.createElement("input"),this.elementQueryInput=document.createElement("textarea"),this.elementTypeSelect=document.createElement("select"),this.elementTimeInput=document.createElement("input"),this.elementSpecialTimeInput=document.createElement("input"),this.saveBtn=document.createElement("button"),this.removeBtn=document.createElement("button"),this.editBtn=document.createElement("button"),this.cancelBtn=document.createElement("button"),this.init()}init(){let a;a=this.options&&this.options.mainWrapperClassName?document.querySelector("."+this.options.mainWrapperClassName):document.querySelector("."+this.removeType),this.setText(),this.actionWrapper.appendChild(this.editBtn),this.container.appendChild(this.removeTypeWrapper),(!this.options||this.options.isShowHost)&&this.container.appendChild(this.hostWrapper),(!this.options||this.options.elementQuery)&&this.container.appendChild(this.elementQueryWrapper),this.container.appendChild(this.elementTypeWrapper),this.container.appendChild(this.elementTimeWrapper),this.container.appendChild(this.elementSpecialTimeWrapper),this.container.appendChild(this.actionWrapper),this.isAdding?a.prepend(this.container):a.appendChild(this.container),this.hostInput.type="text",this.elementTimeInput.type="number",this.elementSpecialTimeInput.type="number",this.saveBtn.innerHTML="Save",this.removeBtn.innerHTML="Remove",this.editBtn.innerHTML="Edit",this.cancelBtn.innerHTML="Cancel",setAttributes(this.container,{"data-bs-toggle":"tooltip","data-placement":"top",title:"Created at: "+this.createAt}),this.actionWrapper.setAttribute("class","text-center"),this.saveBtn.setAttribute("class","btn btn-primary d-inline my-1"),this.removeBtn.setAttribute("class","btn btn-danger d-inline my-1"),this.editBtn.setAttribute("class","btn btn-warning d-inline my-1"),this.cancelBtn.setAttribute("class","btn btn-secondary d-inline my-1"),this.hostInput.setAttribute("class","form-control form-control-sm host-input"),this.elementQueryInput.setAttribute("class","form-control form-control-sm"),this.elementTimeInput.setAttribute("class","form-control form-control-sm interval-time-input"),this.elementSpecialTimeInput.setAttribute("class","form-control form-control-sm loop-times-input"),this.removeTypeSelect.setAttribute("class","form-select form-select-sm remove-type"),this.elementTypeSelect.setAttribute("class","form-select form-select-sm method-type"),this.removeTypeSelect.innerHTML=`
        <option value="rulesRemoveSelector">Remove selector</option>
        <option value="rulesRemoveElement">Remove element</option>`,this.elementTypeSelect.innerHTML=selectTypes.map(a=>`<option value="${a}">${a}</option>`).join(""),this.removeTypeSelect.value=this.removeType?this.removeType:"rulesRemoveSelector",this.hostInput.value=this.host?this.host:"",this.elementQueryInput.value=this.elementQuery?this.elementQuery:"",this.elementTypeSelect.value=this.elementType?this.elementType:selectTypes[0],this.elementTimeInput.value=this.elementTime,this.elementSpecialTimeInput.value=this.elementSpecialTime,this.elementTypeSelect.addEventListener("change",b=>{let a=b.target.value;"interval"==a||"timeout"==a?(this.elementSpecialTimeWrapper.appendChild(this.elementSpecialTimeInput),"interval"==a?this.elementTimeWrapper.appendChild(this.elementTimeInput):this.elementTimeInput.remove()):(this.elementSpecialTimeInput.remove(),this.elementTimeInput.remove())}),this.saveBtn.addEventListener("click",()=>{this.save()}),this.removeBtn.addEventListener("click",()=>{this.remove()}),this.editBtn.addEventListener("click",()=>{this.edit()}),this.cancelBtn.addEventListener("click",()=>{this.isAdding?this.remove():this.backToViewMode()})}edit(){let a=this.elementTypeSelect.value;this.removeTypeWrapper.innerHTML="",this.hostWrapper.innerHTML="",this.elementQueryWrapper.innerHTML="",this.elementTypeWrapper.innerHTML="",this.elementTimeWrapper.innerHTML="",this.elementSpecialTimeWrapper.innerHTML="",this.actionWrapper.innerHTML="",toggleMainNavnContentSize(),this.removeTypeWrapper.appendChild(this.removeTypeSelect),this.hostWrapper.appendChild(this.hostInput),this.elementQueryWrapper.appendChild(this.elementQueryInput),this.elementTypeWrapper.appendChild(this.elementTypeSelect),("interval"==a||"timeout"==a)&&(this.elementTimeWrapper.appendChild(this.elementTimeInput),"interval"==a&&this.elementSpecialTimeWrapper.appendChild(this.elementSpecialTimeInput)),this.actionWrapper.appendChild(this.saveBtn),(!this.options||this.options.isShowRemoveBtn)&&this.actionWrapper.appendChild(this.removeBtn),this.actionWrapper.appendChild(this.cancelBtn),this.editBtn.remove()}save(){let c=this.removeTypeSelect.value,b=this.hostInput.value,a=this.elementQueryInput.value,d=this.elementTypeSelect.value,e=this.elementTimeInput.value,f=this.elementSpecialTimeInput.value;if(this.options&&"function"==typeof this.options.onSave)this.options.onSave({host:b,selector:a,method:d,timeInterval:e,amountLoop:f,removeType:c});else{if(!b||!a||!d){showAlertMessage({title:"Error",type:"danger",message:"Please fill all fields"});return}c!=this.removeType?Promise.all([updateOrDeleteRulesRemove(b,{selector:a,selector:a,method:d,timeInterval:e,amountLoop:f},this.removeType),createRulesRemove(b,{selector:this.elementQuery,selector:this.elementQuery,method:this.elementType,timeInterval:this.elementTime,amountLoop:this.elementSpecialTime},c)]).then(()=>{this.handleSaveValue(),this.container.remove(),document.querySelector("."+c).appendChild(this.container),rulesRemoveAmount[this.removeType]=rulesRemoveAmount[this.removeType]-1,rulesRemoveAmount[c]=rulesRemoveAmount[c]+1,renderRuleRemoveFor(this.removeType)}):updateOrDeleteRulesRemove(b,{selector:a,selector:a,method:d,timeInterval:e,amountLoop:f},c,!0).then(()=>{this.handleSaveValue()})}}handleSaveValue(){this.host=this.hostInput.value,this.elementQuery=this.elementQueryInput.value,this.elementType=this.elementTypeSelect.value,this.elementTime=this.elementTimeInput.value,this.elementSpecialTime=this.elementSpecialTimeInput.value,this.removeType=this.removeTypeSelect.value,this.backToViewMode()}backToViewMode(){this.setText(),this.actionWrapper.appendChild(this.editBtn),this.saveBtn.remove(),this.removeBtn.remove(),this.cancelBtn.remove(),toggleMainNavnContentSize()}remove(){this.isAdding?(this.container.remove(),renderRuleRemoveFor(this.removeType)):updateOrDeleteRulesRemove(this.host,{selector:this.elementQuery,method:this.elementType,timeInterval:this.elementTime,amountLoop:this.elementSpecialTime},this.removeType).then(()=>{this.container.remove(),rulesRemoveAmount[this.removeType]--,renderRuleRemoveFor(this.removeType)})}setText(){this.removeTypeWrapper.innerHTML=`<div class="table-cell-content">${rulesRemovesForRender[this.removeType]}</div>`,this.hostWrapper.innerHTML=`<div class="table-cell-content">${this.host}</div>`,this.elementQueryWrapper.innerHTML=`<div class="table-cell-content">${this.elementQuery}</div>`,this.elementTypeWrapper.innerHTML="undefined"!=this.elementType?`<div class="table-cell-content">${this.elementType}</div>`:"",this.elementTimeWrapper.innerHTML="undefined"!=this.elementTime?`<div class="table-cell-content">${this.elementTime}</div>`:"",this.elementSpecialTimeWrapper.innerHTML="undefined"!=this.elementSpecialTime?`<div class="table-cell-content">${this.elementSpecialTime}</div>`:""}}function renderRuleRemoveFor(a){return getRulesRemove(a).then(b=>{if(b){let c=[],f=document.querySelector("."+a),g=document.querySelector(".text-"+a),h="",d=Object.keys(b);if(f.innerHTML="",d.length>0){for(let i of d)try{let e=b[i].split(",");e.length>0&&e.forEach(b=>{c.push({host:i,rule:b,rulesType:a})})}catch(j){}c.forEach(a=>{new ElementBlockingInfo(a.host,a.rule,a.rulesType),h+=createTextItemForRule(a.host,a.rule)})}rulesRemoveAmount[a]=c.length,g.value=h}renderRuleRemoveIfEmptyRules()})}function renderRuleRemoveIfEmptyRules(){let a=document.querySelector(".rulesRemoveSelector"),b=document.querySelector(".rulesRemoveElement"),c='<td colspan="7" class="text-center table-active no-row">No data</td>';if(0==rulesRemoveAmount.rulesRemoveSelector)a.innerHTML=c;else{let d=a.querySelector(".no-row");d&&d.remove()}if(0==rulesRemoveAmount.rulesRemoveElement)b.innerHTML=c;else{let e=b.querySelector(".no-row");e&&e.remove()}}function toggleMainNavnContentSize(){toggleMultipleClass(document.querySelector(".main-navigation"),["col-md-3","col-md-2"]),toggleMultipleClass(document.querySelector(".main-content"),["col-md-9","col-md-10"])}function toggleMultipleClass(b,a){a.forEach(a=>{b.classList.toggle(a)})}function renderGeneralSeting(){getFromChromeStorage("generalSetings").then(({generalSetings:a})=>{a||(a={});let b=a.isEnableDialog,c=a.isEnableAutoUnblockCopy,d=a.isEnableAutoUnblockScroll,e=document.querySelector(".set-default-quick-select"),f=document.querySelector(".select-level-unblock-copy-wrapper"),g=document.querySelector(".select-level-unblock-scroll-wrapper"),h=a.selectorOptions?a.selectorOptions:"",i=a.quickRemoveType?a.quickRemoveType:"",j=genaralPageSwitchers[0],k=genaralPageSwitchers[1],l=rangeUnblockLevels[0],m=genaralPageSwitchers[2],n=rangeUnblockLevels[1];j.checked=b,k.checked=c,m.checked=d,l.value=a.unblockCopyLevel,n.value=a.unblockScrollLevel,document.querySelector(".quick-select-option").innerHTML="",quickSelectBlockSetting=new ElementBlockingInfo("",h,i,!1,{mainWrapperClassName:"quick-select-option",onSave({method:b,timeInterval:c,amountLoop:d,removeType:a}){setValueForGeneralSettings({quickRemoveType:a,selectorOptions:a+"|"+b+"|"+c+"|"+d}).then(()=>{quickSelectBlockSetting.handleSaveValue()})}}),toggleClassWithCondition(e,["disabled-all"],b),toggleClassWithCondition(f,["disabled-all"],!c),toggleClassWithCondition(g,["disabled-all"],!d)})}function createTextItemForRule(b,c){let a=c.split("|"),d=a[0],e=a[1],f="undefined"!==a[2]?a[2]:"",g="undefined"!==a[3]?a[3]:"",h="undefined"!==a[4]?a[4]:"";return"---------------------------\n@host: "+b+"\n@createAt: "+h+"\n@selector: "+d+"\n@block method: "+e+"\n@time Interval: "+f+"\n@times loop: "+g+"\n"}function textToRule(b){let a=b.split("---------------------------");a.shift();let c=[];return a.forEach(f=>{let a=f.split("\n"),b=a[1].split("@host: ")[1],g=a[2].split("@createAt: ")[1],d=a[3].split("@selector: ")[1],e=a[4].split("@block method: ")[1],h=a[5].split("@time Interval: ")[1],i=a[6].split("@times loop: ")[1];b&&d&&e&&c.push({host:b,ruleInfo:d+"|"+e+"|"+h+"|"+i+"|"+g})}),c}chrome.runtime.onMessage.addListener(function(a,b,c){switch(a.name){case"updateRules":renderRuleRemoveFor(a.selectorType);break;case"unblock-scroll":case"unblock-copy":renderGeneralSeting()}}),renderGeneralSeting(),renderRuleRemoveFor("rulesRemoveElement"),renderRuleRemoveFor("rulesRemoveSelector"),switchPageBtns.forEach((a,b)=>{a.addEventListener("click",()=>{removeOldActivedBtnAndPage(),switchPageBtns[b].classList.add("active"),addMultipleClass(pages[b],["active","show"])})}),switcherEditModes.forEach(a=>{a.addEventListener("click",e=>{let a=e.target,f=a.checked,b=a.getAttribute("for-rule"),c=document.querySelector(`.textarea-${b}`),d=document.querySelector(`.table-${b}-wrapper`);f?(c.classList.remove("d-none"),d.classList.add("d-none")):(c.classList.add("d-none"),d.classList.remove("d-none"))})}),addRulesBtns.forEach(a=>{a.addEventListener("click",()=>{let b=a.getAttribute("for-rules");new ElementBlockingInfo("","",b,!0).edit()})}),genaralPageSwitchers.forEach(a=>{a.addEventListener("change",b=>{let a=b.target,c=a.checked,e=a.getAttribute("toggle-el"),d=a.getAttribute("general-attr");setValueForGeneralSettings({[d]:c}).then(()=>{document.querySelector("."+e).classList.toggle("disabled-all")})})}),rangeUnblockLevels.forEach(a=>{a.addEventListener("change",b=>{let a=b.target,c=a.value,d=a.getAttribute("unblock-for");setValueForGeneralSettings({[d]:c})})}),saveRulesBtns.forEach(a=>{a.addEventListener("click",c=>{let a=c.target.getAttribute("for-rules"),b=textToRule(document.querySelector(".text-"+a).value);0==b.length?showAlertMessage({title:"Error",type:"danger",message:"The rules are not valid"}):createMultipleRulesRemove(b,a).then(()=>{showAlertMessage({title:"Success",type:"success",message:"Saved successfully"}),renderRuleRemoveFor(a)}).catch(()=>{showAlertMessage({title:"Error",type:"danger",message:"Error while saving"})})})})